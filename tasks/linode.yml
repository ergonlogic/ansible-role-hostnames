---

- name: Set or update hostname.
  hostname:
    name: "{{ linode_name }}"

- name: Update /etc/hostname.
  copy:
    content: "{{ linode_name }}"
    dest: /etc/hostname
    owner: root
    group: root
    mode: 0644

- name: Update /etc/hosts with localhost.
  lineinfile:
    dest: /etc/hosts
    regexp: "^127.0.0.1"
    line: "127.0.0.1 {{ linode_name }}.{{ linode_zone }} {{ linode_name }} localhost"
    state: present

- name: Build hosts file, to include each of the *other* hosts.
  lineinfile:
    dest: /etc/hosts
    regexp: ".*{{ hostvars[item].linode_name }}$"
    line: "{{ hostvars[item].public_ip }} {{ hostvars[item].linode_name }}.{{ linode_zone }} {{ hostvars[item].linode_name }}"
    state: present
  when: (hostvars[item].linode_name != linode_name)
  with_items:
  - "{{ groups['linode'] }}"

